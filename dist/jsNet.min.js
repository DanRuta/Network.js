"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function t(t,e){var i=[],a=!0,r=!1,n=void 0;try{for(var s,o=t[Symbol.iterator]();!(a=(s=o.next()).done)&&(i.push(s.value),!e||i.length!==e);a=!0);}catch(t){r=!0,n=t}finally{try{!a&&o.return&&o.return()}finally{if(r)throw n}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),ConvLayer=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=i.filterSize,r=i.zeroPadding,n=i.stride,s=i.activation;_classCallCheck(this,t),a&&(this.filterSize=a),n&&(this.stride=n),e&&(this.size=e),this.zeroPadding=r,void 0!=s&&(this.activation=!("boolean"==typeof s&&!s)&&("function"==typeof s?s:NetMath[NetUtil.format(s)].bind(this))),this.state="not-initialised"}return _createClass(t,[{key:"assignNext",value:function(t){this.nextLayer=t}},{key:"assignPrev",value:function(t,e){switch(this.prevLayer=t,this.size=this.size||4,this.filterSize=this.filterSize||this.net.conv.filterSize||3,this.stride=this.stride||this.net.conv.stride||1,t.constructor.name){case"FCLayer":this.channels=this.net.channels||1;break;case"ConvLayer":this.channels=t.size;break;case"PoolLayer":this.channels=t.activations.length}void 0==this.zeroPadding&&(this.zeroPadding=void 0==this.net.conv.zeroPadding?Math.floor(this.filterSize/2):this.net.conv.zeroPadding);var i=t instanceof FCLayer?Math.max(Math.floor(Math.sqrt(t.size/this.channels)),1):t.outMapSize;if(this.inMapValuesCount=Math.pow(i,2),this.inZPMapValuesCount=Math.pow(i+2*this.zeroPadding,2),this.outMapSize=(i-this.filterSize+2*this.zeroPadding)/this.stride+1,this.outMapSize%1!=0)throw new Error("Misconfigured hyperparameters. Activation volume dimensions would be "+this.outMapSize+" in conv layer at index "+e);this.filters=[].concat(_toConsumableArray(new Array(this.size))).map(function(t){return new Filter})}},{key:"init",value:function(){var t=this;this.filters.forEach(function(e){e.weights=[].concat(_toConsumableArray(new Array(t.channels))).map(function(e){return[].concat(_toConsumableArray(new Array(t.filterSize))).map(function(e){return t.net.weightsInitFn(t.filterSize*(t.prevLayer.channels||1),t.weightsConfig)})}),e.activationMap=[].concat(_toConsumableArray(new Array(t.outMapSize))).map(function(e){return[].concat(_toConsumableArray(new Array(t.outMapSize))).map(function(t){return 0})}),e.errorMap=[].concat(_toConsumableArray(new Array(t.outMapSize))).map(function(e){return[].concat(_toConsumableArray(new Array(t.outMapSize))).map(function(t){return 0})}),e.dropoutMap=e.activationMap.map(function(t){return t.map(function(t){return!1})}),e.bias=.2*Math.random()-.1,e.init({updateFn:t.net.updateFn,activation:t.net.activationConfig,eluAlpha:t.net.eluAlpha})})}},{key:"forward",value:function(){for(var t=NetUtil.getActivations(this.prevLayer),e=0;e<this.size;e++){var i=this.filters[e];i.sumMap=NetUtil.convolve({input:t,zeroPadding:this.zeroPadding,weights:i.weights,channels:this.channels,stride:this.stride,bias:i.bias});for(var a=0;a<i.sumMap.length;a++)for(var r=0;r<i.sumMap.length;r++)"training"==this.state&&(i.dropoutMap[a][r]=Math.random()>this.net.dropout)?i.activationMap[a][r]=0:this.activation?i.activationMap[a][r]=this.activation(i.sumMap[a][r],!1,i)/(this.net.dropout||1):i.activationMap[a][r]=i.sumMap[a][r]}}},{key:"backward",value:function(){if(this.nextLayer instanceof FCLayer)for(var e=0;e<this.filters.length;e++)for(var i=this.filters[e],a=0;a<i.errorMap.length;a++)for(var r=0;r<i.errorMap.length;r++)for(var n=e*Math.pow(this.outMapSize,2)+a*i.errorMap.length+r,s=0;s<this.nextLayer.neurons.length;s++){var o=this.nextLayer.neurons[s];i.errorMap[a][r]+=o.error*o.weights[n]}else if(this.nextLayer instanceof t)for(var h=0;h<this.filters.length;h++)NetUtil.buildConvErrorMap(this.nextLayer,this.filters[h].errorMap,h);else for(var l=0;l<this.filters.length;l++)for(var u=this.filters[l],c=0;c<u.errorMap.length;c++)for(var f=0;f<u.errorMap.length;f++)u.errorMap[c][f]=this.nextLayer.errors[l][c][f];for(var v=0;v<this.filters.length;v++)for(var d=this.filters[v],g=0;g<d.errorMap.length;g++)for(var p=0;p<d.errorMap[0].length;p++)d.dropoutMap[g][p]?d.errorMap[g][p]=0:this.activation&&(d.errorMap[g][p]*=this.activation(d.sumMap[g][p],!0,d));NetUtil.buildConvDWeights(this)}},{key:"resetDeltaWeights",value:function(){for(var t=0;t<this.filters.length;t++){for(var e=this.filters[t],i=0;i<e.deltaWeights.length;i++)for(var a=0;a<e.deltaWeights[0].length;a++)for(var r=0;r<e.deltaWeights[0][0].length;r++)e.deltaWeights[i][a][r]=0;for(var n=0;n<e.dropoutMap.length;n++)for(var s=0;s<e.dropoutMap[0].length;s++)e.dropoutMap[n][s]=!1}}},{key:"applyDeltaWeights",value:function(){for(var t=0;t<this.filters.length;t++){for(var e=this.filters[t],i=0;i<e.deltaWeights.length;i++)for(var a=0;a<e.deltaWeights[0].length;a++)for(var r=0;r<e.deltaWeights[0][0].length;r++)void 0!=this.net.l2&&(this.net.l2Error+=.5*this.net.l2*Math.pow(e.weights[i][a][r],2)),void 0!=this.net.l1&&(this.net.l1Error+=this.net.l1*Math.abs(e.weights[i][a][r])),e.weights[i][a][r]=this.net.weightUpdateFn.bind(this.net,e.weights[i][a][r],e.deltaWeights[i][a][r],e,[i,a,r])(),void 0!=this.net.maxNorm&&(this.net.maxNormTotal+=Math.pow(e.weights[i][a][r],2));e.bias=this.net.weightUpdateFn.bind(this.net,e.bias,e.deltaBias,e)()}}},{key:"toJSON",value:function(){return{weights:this.filters.map(function(t){return{bias:t.bias,weights:t.weights}})}}},{key:"fromJSON",value:function(t,e){this.filters.forEach(function(i,a){if(t.weights[a].weights.length!=i.weights.length)throw new Error("Mismatched weights depth. Given: "+t.weights[a].weights.length+" Existing: "+i.weights.length+". At: layers["+e+"], filters["+a+"]");if(t.weights[a].weights[0].length!=i.weights[0].length)throw new Error("Mismatched weights size. Given: "+t.weights[a].weights[0].length+" Existing: "+i.weights[0].length+". At: layers["+e+"], filters["+a+"]");i.bias=t.weights[a].bias,i.weights=t.weights[a].weights})}}]),t}();"undefined"==typeof window&&(exports.ConvLayer=ConvLayer);var FCLayer=function(){function t(e){_classCallCheck(this,t),this.size=e,this.neurons=[].concat(_toConsumableArray(new Array(e))).map(function(t){return new Neuron}),this.state="not-initialised"}return _createClass(t,[{key:"assignNext",value:function(t){this.nextLayer=t}},{key:"assignPrev",value:function(t){this.prevLayer=t}},{key:"init",value:function(){var t=this;this.neurons.forEach(function(e){var i=void 0;switch(t.prevLayer.constructor.name){case"FCLayer":i=t.prevLayer.size;break;case"ConvLayer":i=t.prevLayer.filters.length*Math.pow(t.prevLayer.outMapSize,2);break;case"PoolLayer":i=t.prevLayer.activations.length*Math.pow(t.prevLayer.outMapSize,2)}e.weights=t.net.weightsInitFn(i,t.weightsConfig),e.bias=.2*Math.random()-.1,e.init({updateFn:t.net.updateFn,activationConfig:t.net.activationConfig,eluAlpha:t.net.eluAlpha})})}},{key:"forward",value:function(){var t=this;this.neurons.forEach(function(e,i){if("training"==t.state&&(e.dropped=Math.random()>t.net.dropout))e.activation=0;else{e.sum=e.bias;for(var a=NetUtil.getActivations(t.prevLayer),r=0;r<a.length;r++)e.sum+=a[r]*e.weights[r];e.activation=t.activation(e.sum,!1,e)/(t.net.dropout||1)}})}},{key:"backward",value:function(t){var e=this;this.neurons.forEach(function(i,a){if(i.dropped)i.error=0,i.deltaBias=0;else{void 0!==t?i.error=t[a]-i.activation:(i.derivative=e.activation(i.sum,!0,i),i.error=i.derivative*e.nextLayer.neurons.map(function(t){return t.error*(0|t.weights[a])}).reduce(function(t,e){return t+e},0));for(var r=NetUtil.getActivations(e.prevLayer),n=0;n<i.weights.length;n++)i.deltaWeights[n]+=i.error*r[n]*(1+((e.net.l2||0)+(e.net.l1||0))/e.net.miniBatchSize*i.deltaWeights[n]);i.deltaBias=i.error}})}},{key:"resetDeltaWeights",value:function(){this.neurons.forEach(function(t){return t.deltaWeights=t.weights.map(function(t){return 0})})}},{key:"applyDeltaWeights",value:function(){var t=this;this.neurons.forEach(function(e){e.deltaWeights.forEach(function(i,a){void 0!=t.net.l2&&(t.net.l2Error+=.5*t.net.l2*Math.pow(e.weights[a],2)),void 0!=t.net.l1&&(t.net.l1Error+=t.net.l1*Math.abs(e.weights[a])),e.weights[a]=t.net.weightUpdateFn.bind(t.net,e.weights[a],i,e,a)(),void 0!=t.net.maxNorm&&(t.net.maxNormTotal+=Math.pow(e.weights[a],2))}),e.bias=t.net.weightUpdateFn.bind(t.net,e.bias,e.deltaBias,e)()})}},{key:"toJSON",value:function(){return{weights:this.neurons.map(function(t){return{bias:t.bias,weights:t.weights}})}}},{key:"fromJSON",value:function(t,e){this.neurons.forEach(function(i,a){if(t.weights[a].weights.length!=i.weights.length)throw new Error("Mismatched weights count. Given: "+t.weights[a].weights.length+" Existing: "+i.weights.length+". At layers["+e+"], neurons["+a+"]");i.bias=t.weights[a].bias,i.weights=t.weights[a].weights})}}]),t}(),Layer=FCLayer;"undefined"==typeof window&&(exports.FCLayer=exports.Layer=FCLayer);var Filter=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"init",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.updateFn,a=e.activation,r=e.eluAlpha;this.weights.length;switch(this.deltaWeights=this.weights.map(function(t){return t.map(function(t){return t.map(function(t){return 0})})}),this.deltaBias=0,i){case"gain":this.biasGain=1,this.weightGains=this.weights.map(function(t){return t.map(function(t){return t.map(function(t){return 1})})}),this.getWeightGain=function(e){var i=_slicedToArray(e,3),a=i[0],r=i[1],n=i[2];return t.weightGains[a][r][n]},this.setWeightGain=function(e,i){var a=_slicedToArray(e,3),r=a[0],n=a[1],s=a[2];return t.weightGains[r][n][s]=i};break;case"adagrad":case"rmsprop":case"adadelta":this.biasCache=0,this.weightsCache=this.weights.map(function(t){return t.map(function(t){return t.map(function(t){return 0})})}),this.getWeightsCache=function(e){var i=_slicedToArray(e,3),a=i[0],r=i[1],n=i[2];return t.weightsCache[a][r][n]},this.setWeightsCache=function(e,i){var a=_slicedToArray(e,3),r=a[0],n=a[1],s=a[2];return t.weightsCache[r][n][s]=i},"adadelta"==i&&(this.adadeltaBiasCache=0,this.adadeltaCache=this.weights.map(function(t){return t.map(function(t){return t.map(function(t){return 0})})}),this.getAdadeltaCache=function(e){var i=_slicedToArray(e,3),a=i[0],r=i[1],n=i[2];return t.adadeltaCache[a][r][n]},this.setAdadeltaCache=function(e,i){var a=_slicedToArray(e,3),r=a[0],n=a[1],s=a[2];return t.adadeltaCache[r][n][s]=i});break;case"adam":this.m=0,this.v=0}"rrelu"==a?this.rreluSlope=.001*Math.random():"elu"==a&&(this.eluAlpha=r)}},{key:"getWeight",value:function(t){var e=_slicedToArray(t,3),i=e[0],a=e[1],r=e[2];return this.weights[i][a][r]}},{key:"setWeight",value:function(t,e){var i=_slicedToArray(t,3),a=i[0],r=i[1],n=i[2];this.weights[a][r][n]=e}},{key:"getDeltaWeight",value:function(t){var e=_slicedToArray(t,3),i=e[0],a=e[1],r=e[2];return this.deltaWeights[i][a][r]}},{key:"setDeltaWeight",value:function(t,e){var i=_slicedToArray(t,3),a=i[0],r=i[1],n=i[2];this.deltaWeights[a][r][n]=e}}]),t}();"undefined"==typeof window&&(exports.Filter=Filter);var NetMath=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"sigmoid",value:function(t,e){var i=1/(1+Math.exp(-t));return e?i*(1-i):i}},{key:"tanh",value:function(t,e){var i=Math.exp(2*t);return e?4/Math.pow(Math.exp(t)+Math.exp(-t),2)||1e-18:(i-1)/(i+1)||1e-18}},{key:"relu",value:function(t,e){return e?t>0?1:0:Math.max(t,0)}},{key:"lrelu",value:function(t,e){return e?t>0?1:this.lreluSlope||-5e-4:Math.max((this.lreluSlope||-5e-4)*Math.abs(t),t)}},{key:"rrelu",value:function(t,e,i){return e?t>0?1:i.rreluSlope:Math.max(i.rreluSlope,t)}},{key:"lecuntanh",value:function(e,i){return i?1.15333*Math.pow(t.sech(2/3*e),2):1.7159*t.tanh(2/3*e)}},{key:"elu",value:function(e,i,a){return i?e>=0?1:t.elu(e,!1,a)+a.eluAlpha:e>=0?e:a.eluAlpha*(Math.exp(e)-1)}},{key:"crossentropy",value:function(t,e){return e.map(function(e,i){return t[i]*Math.log(e+1e-15)+(1-t[i])*Math.log(1+1e-15-e)}).reduce(function(t,e){return t-e},0)}},{key:"meansquarederror",value:function(t,e){return t.map(function(t,i){return Math.pow(t-e[i],2)}).reduce(function(t,e){return t+e},0)/t.length}},{key:"vanillaupdatefn",value:function(t,e){return t+this.learningRate*e}},{key:"gain",value:function(t,e,i,a){var r=t+this.learningRate*e*(null==a?i.biasGain:i.getWeightGain(a));return r<=0&&t>0||r>=0&&t<0?null!=a?i.setWeightGain(a,Math.max(.95*i.getWeightGain(a),.5)):i.biasGain=Math.max(.95*i.biasGain,.5):null!=a?i.setWeightGain(a,Math.min(i.getWeightGain(a)+.05,5)):i.biasGain=Math.min(i.biasGain+.05,5),r}},{key:"adagrad",value:function(t,e,i,a){return null!=a?i.setWeightsCache(a,i.getWeightsCache(a)+Math.pow(e,2)):i.biasCache+=Math.pow(e,2),t+this.learningRate*e/(1e-6+Math.sqrt(null!=a?i.getWeightsCache(a):i.biasCache))}},{key:"rmsprop",value:function(t,e,i,a){return null!=a?i.setWeightsCache(a,this.rmsDecay*i.getWeightsCache(a)+(1-this.rmsDecay)*Math.pow(e,2)):i.biasCache=this.rmsDecay*i.biasCache+(1-this.rmsDecay)*Math.pow(e,2),t+this.learningRate*e/(1e-6+Math.sqrt(null!=a?i.getWeightsCache(a):i.biasCache))}},{key:"adam",value:function(t,e,i){i.m=.9*i.m+(1-.9)*e;var a=i.m/(1-Math.pow(.9,this.iterations+1));i.v=.999*i.v+(1-.999)*Math.pow(e,2);var r=i.v/(1-Math.pow(.999,this.iterations+1));return t+this.learningRate*a/(Math.sqrt(r)+1e-8)}},{key:"adadelta",value:function(t,e,i,a){if(null!=a){i.setWeightsCache(a,this.rho*i.getWeightsCache(a)+(1-this.rho)*Math.pow(e,2));var r=t+Math.sqrt((i.getAdadeltaCache(a)+1e-6)/(i.getWeightsCache(a)+1e-6))*e;return i.setAdadeltaCache(a,this.rho*i.getAdadeltaCache(a)+(1-this.rho)*Math.pow(e,2)),r}i.biasCache=this.rho*i.biasCache+(1-this.rho)*Math.pow(e,2);var n=t+Math.sqrt((i.adadeltaBiasCache+1e-6)/(i.biasCache+1e-6))*e;return i.adadeltaBiasCache=this.rho*i.adadeltaBiasCache+(1-this.rho)*Math.pow(e,2),n}},{key:"uniform",value:function(t,e){var i=e.limit;return[].concat(_toConsumableArray(new Array(t))).map(function(t){return 2*Math.random()*i-i})}},{key:"gaussian",value:function(t,e){var i=e.mean,a=e.stdDeviation;return[].concat(_toConsumableArray(new Array(t))).map(function(){var t=void 0,e=void 0,r=void 0;do{t=2*Math.random()-1,e=2*Math.random()-1,r=Math.pow(t,2)+Math.pow(e,2)}while(r>=1||!r);return i+t*Math.sqrt(-2*Math.log(r)/r)*a})}},{key:"xaviernormal",value:function(e,i){var a=i.fanIn,r=i.fanOut;return r||0==r?t.gaussian(e,{mean:0,stdDeviation:Math.sqrt(2/(a+r))}):t.lecunnormal(e,{fanIn:a})}},{key:"xavieruniform",value:function(e,i){var a=i.fanIn,r=i.fanOut;return r||0==r?t.uniform(e,{limit:Math.sqrt(6/(a+r))}):t.lecununiform(e,{fanIn:a})}},{key:"lecunnormal",value:function(e,i){var a=i.fanIn;return t.gaussian(e,{mean:0,stdDeviation:Math.sqrt(1/a)})}},{key:"lecununiform",value:function(e,i){var a=i.fanIn;return t.uniform(e,{limit:Math.sqrt(3/a)})}},{key:"maxPool",value:function(t,e){for(var i=NetUtil.getActivations(t.prevLayer,e,t.inMapValuesCount),a=0;a<t.outMapSize;a++)for(var r=0;r<t.outMapSize;r++){for(var n=a*t.stride,s=r*t.stride,o=i[n*t.prevLayerOutWidth+s],h=0;h<t.size;h++)for(var l=0;l<t.size;l++){var u=i[(n+h)*t.prevLayerOutWidth+(s+l)];u>o&&(o=u,t.indeces[e][a][r]=[h,l])}t.activations[e][a][r]=o}}},{key:"softmax",value:function(t){var e=t.reduce(function(t,e){return t+e},0);return t.map(function(t){return t/e})}},{key:"sech",value:function(t){return 2*Math.exp(-t)/(1+Math.exp(-2*t))}},{key:"standardDeviation",value:function(t){var e=t.reduce(function(t,e){return t+e})/t.length,i=t.map(function(t){return t-e}).map(function(t){return Math.pow(t,2)});return Math.sqrt(i.reduce(function(t,e){return t+e})/i.length)}},{key:"maxNorm",value:function(){if(this.maxNormTotal>this.maxNorm){var t=this.maxNorm/(1e-18+this.maxNormTotal);this.layers.forEach(function(e,i){i&&e.neurons.forEach(function(e){e.weights.forEach(function(i,a){return e.setWeight(a,e.getWeight(a)*t)})})})}this.maxNormTotal=0}}]),t}();"undefined"==typeof window&&(exports.NetMath=NetMath);var NetUtil=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"format",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"string";switch(!0){case"string"==e&&"string"==typeof t:t=t.replace(/(_|\s)/g,"").toLowerCase();break;case"time"==e&&"number"==typeof t:var i=new Date(t),a=[];t<1e3?a.push(i.getMilliseconds()+"ms"):(t>=36e5&&a.push(i.getHours()+"h"),t>=6e4&&a.push(i.getMinutes()+"m"),a.push(i.getSeconds()+"s")),t=a.join(" ")}return t}},{key:"shuffle",value:function(t){for(var e=t.length;e;e--){var i=Math.floor(Math.random()*e),a=t[e-1];t[e-1]=t[i],t[i]=a}}},{key:"addZeroPadding",value:function(t,e){for(var i=[],a=0;a<t.length;a++)i.push(t[a].slice(0));for(var r=[],n=0;n<i.length+2*e;n++)r.push(0);for(var s=0;s<i.length;s++)for(var o=0;o<e;o++)i[s].splice(0,0,0),i[s].splice(i.length+1,i.length,0);for(var h=0;h<e;h++)i.splice(0,0,r.slice(0)),i.splice(i.length,i.length-1,r.slice(0));return i}},{key:"arrayToMap",value:function(t,e){for(var i=[],a=0;a<e;a++){i[a]=[];for(var r=0;r<e;r++)i[a][r]=t[a*e+r]}return i}},{key:"arrayToVolume",value:function(t,e){for(var i=[],a=Math.sqrt(t.length/e),r=Math.pow(a,2),n=0;n<Math.floor(t.length/r);n++){for(var s=[],o=0;o<a;o++){s[o]=[];for(var h=0;h<a;h++)s[o][h]=t[n*r+o*a+h]}i[n]=s}return i}},{key:"convolve",value:function(e){for(var i=e.input,a=e.zeroPadding,r=e.weights,n=e.channels,s=e.stride,o=e.bias,h=t.arrayToVolume(i,n),l=[],u=h[0].length+2*a,c=Math.floor(r[0].length/2),f=0;f<n;f++){h[f]=t.addZeroPadding(h[f],a);for(var v=c;v<u-c;v+=s){l[(v-c)/s]=l[(v-c)/s]||[];for(var d=c;d<u-c;d+=s){for(var g=0,p=0;p<r[0].length;p++)for(var y=0;y<r[0].length;y++)g+=h[f][v+(p-c)][d+(y-c)]*r[f][p][y];l[(v-c)/s][(d-c)/s]=(l[(v-c)/s][(d-c)/s]||0)+g}}}for(var w=0;w<l.length;w++)for(var m=0;m<l.length;m++)l[w][m]+=o;return l}},{key:"buildConvErrorMap",value:function(t,e,i){for(var a=t.zeroPadding,r=e.length+2*a,n=Math.floor(t.filterSize/2),s=[],o=0;o<r;o++)s.push(0);for(var h=0;h<r;h++)e[h]=s.slice(0);for(var l=0;l<t.size;l++)for(var u=t.filters[l].weights[i],c=t.filters[l].errorMap,f=n;f<r-n;f+=t.stride)for(var v=n;v<r-n;v+=t.stride)for(var d=0;d<t.filterSize;d++)for(var g=0;g<t.filterSize;g++)e[f+(d-n)][v+(g-n)]+=u[d][g]*c[(f-n)/t.stride][(v-n)/t.stride];e.splice(0,a),e.splice(e.length-a,e.length);for(var p=0;p<e.length;p++)e[p]=e[p].splice(a,e[p].length-2*a)}},{key:"buildConvDWeights",value:function(e){for(var i=e.filters[0].weights[0].length,a=Math.floor(i/2),r=e.filters[0].weights.length,n=[],s=0;s<i;s++){n[s]=[];for(var o=0;o<i;o++)n[s][o]=0}for(var h=0;h<e.filters.length;h++){for(var l=e.filters[h],u=0;u<r;u++)for(var c=t.getActivations(e.prevLayer,u,e.inMapValuesCount),f=t.addZeroPadding(t.arrayToMap(c,Math.sqrt(e.inMapValuesCount)),e.zeroPadding),v=a;v<f.length-a;v+=e.stride)for(var d=a;d<f.length-a;d+=e.stride){for(var g=0;g<i;g++)for(var p=0;p<i;p++){var y=f[v-a+g][d-a+p];n[g][p]+=y*(1+((e.net.l2||0)+(e.net.l1||0))/e.net.miniBatchSize*l.weights[u][g][p])}for(var w=l.errorMap[(v-a)/e.stride][(d-a)/e.stride],m=0;m<i;m++)for(var M=0;M<i;M++)l.deltaWeights[u][m][M]+=n[m][M]*w,n[m][M]=0}for(var C=0;C<l.errorMap.length;C++)for(var b=0;b<l.errorMap.length;b++)l.deltaBias+=l.errorMap[C][b]}}},{key:"getActivations",value:function(t,e,i){var a=[];if(1==arguments.length)if(t instanceof FCLayer)for(var r=0;r<t.neurons.length;r++)a.push(t.neurons[r].activation);else if(t instanceof ConvLayer)for(var n=0;n<t.filters.length;n++)for(var s=0;s<t.filters[n].activationMap.length;s++)for(var o=0;o<t.filters[n].activationMap[s].length;o++)a.push(t.filters[n].activationMap[s][o]);else for(var h=0;h<t.activations.length;h++)for(var l=0;l<t.activations[0].length;l++)for(var u=0;u<t.activations[0].length;u++)a.push(t.activations[h][l][u]);else if(t instanceof FCLayer)for(var c=e*i;c<(e+1)*i;c++)a.push(t.neurons[c].activation);else if(t instanceof ConvLayer)for(var f=0;f<t.filters[e].activationMap.length;f++)for(var v=0;v<t.filters[e].activationMap[f].length;v++)a.push(t.filters[e].activationMap[f][v]);else for(var d=0;d<t.activations[e].length;d++)for(var g=0;g<t.activations[e].length;g++)a.push(t.activations[e][d][g]);return a}}]),t}();"undefined"==typeof window&&(exports.NetUtil=NetUtil);var Network=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.learningRate,a=e.layers,r=void 0===a?[]:a,n=e.updateFn,s=void 0===n?"vanillaupdatefn":n,o=e.activation,h=void 0===o?"sigmoid":o,l=e.cost,u=void 0===l?"meansquarederror":l,c=e.rmsDecay,f=e.rho,v=e.lreluSlope,d=e.eluAlpha,g=e.dropout,p=void 0===g?1:g,y=e.l2,w=void 0===y||y,m=e.l1,M=void 0===m||m,C=e.maxNorm,b=e.weightsConfig,k=e.channels,z=e.conv,A=e.pool;switch(_classCallCheck(this,t),this.state="not-defined",this.layers=[],this.conv={},this.pool={},this.epochs=0,this.iterations=0,this.dropout=0==p?1:p,this.error=0,h=NetUtil.format(h),s=NetUtil.format(s),u=NetUtil.format(u),w&&(this.l2="boolean"==typeof w?.001:w,this.l2Error=0),M&&(this.l1="boolean"==typeof M?.005:M,this.l1Error=0),C&&(this.maxNorm="boolean"==typeof C&&C?1e3:C,this.maxNormTotal=0),i&&(this.learningRate=i),k&&(this.channels=k),z&&(void 0!=z.filterSize&&(this.conv.filterSize=z.filterSize),void 0!=z.zeroPadding&&(this.conv.zeroPadding=z.zeroPadding),void 0!=z.stride&&(this.conv.stride=z.stride)),A&&(A.size&&(this.pool.size=A.size),A.stride&&(this.pool.stride=A.stride)),s){case"rmsprop":this.learningRate=void 0==this.learningRate?.001:this.learningRate;break;case"adam":this.learningRate=void 0==this.learningRate?.01:this.learningRate;break;case"adadelta":this.rho=null==f?.95:f;break;default:if(void 0==this.learningRate)switch(h){case"relu":case"lrelu":case"rrelu":case"elu":this.learningRate=.01;break;case"tanh":case"lecuntanh":this.learningRate=.001;break;default:this.learningRate=.2}}if(this.updateFn=[!1,null,void 0].includes(s)?"vanillaupdatefn":s,this.weightUpdateFn=NetMath[this.updateFn],this.activation="function"==typeof h?h:NetMath[h].bind(this),this.activationConfig=h,this.cost="function"==typeof u?u:NetMath[u],"rmsprop"==this.updateFn&&(this.rmsDecay=void 0==c?.99:c),this.lreluSlope=void 0==v?-5e-4:v,this.eluAlpha=void 0==d?1:d,this.weightsConfig={distribution:"xavieruniform"},void 0!=b&&b.distribution&&(this.weightsConfig.distribution=NetUtil.format(b.distribution)),"uniform"==this.weightsConfig.distribution?this.weightsConfig.limit=b&&void 0!=b.limit?b.limit:.1:"gaussian"==this.weightsConfig.distribution&&(this.weightsConfig.mean=b.mean||0,this.weightsConfig.stdDeviation=b.stdDeviation||.05),"function"==typeof this.weightsConfig.distribution?this.weightsInitFn=this.weightsConfig.distribution:this.weightsInitFn=NetMath[this.weightsConfig.distribution],r.length)switch(!0){case r.every(function(t){return Number.isInteger(t)}):this.layers=r.map(function(t){return new FCLayer(t)}),this.state="constructed",this.initLayers();break;case r.every(function(t){return["FCLayer","ConvLayer","PoolLayer"].includes(t.constructor.name)}):this.state="constructed",this.layers=r,this.initLayers();break;default:throw new Error("There was an error constructing from the layers given.")}}return _createClass(t,[{key:"initLayers",value:function(t,e){switch(this.state){case"initialised":return;case"not-defined":this.layers[0]=new FCLayer(t),this.layers[1]=new FCLayer(Math.ceil(t/e>5?e+Math.abs(t-e)/4:t+e)),this.layers[2]=new FCLayer(Math.ceil(e))}this.layers.forEach(this.joinLayer.bind(this)),this.state="initialised"}},{key:"joinLayer",value:function(t,e){t.net=this,t.activation=void 0==t.activation?this.activation:t.activation,t.weightsConfig={},Object.assign(t.weightsConfig,this.weightsConfig),e&&(this.layers[e-1].assignNext(t),t.assignPrev(this.layers[e-1],e),t.weightsConfig.fanIn=t.prevLayer.size,t.prevLayer.weightsConfig.fanOut=t.size,t.init(),t.state="initialised")}},{key:"forward",value:function(t){if("initialised"!=this.state)throw new Error("The network layers have not been initialised.");if(void 0===t||null===t)throw new Error("No data passed to Network.forward()");return t.length!=this.layers[0].neurons.length&&console.warn("Input data length did not match input layer neurons count."),this.layers[0].neurons.forEach(function(e,i){return e.activation=t[i]}),this.layers.forEach(function(e,i){return i&&e.forward(t)}),this.layers[this.layers.length-1].neurons.map(function(t){return t.activation})}},{key:"backward",value:function(t){if(void 0===t)throw new Error("No data passed to Network.backward()");t.length!=this.layers[this.layers.length-1].neurons.length&&console.warn("Expected data length did not match output layer neurons count.",t),this.layers[this.layers.length-1].backward(t);for(var e=this.layers.length-2;e>0;e--)this.layers[e].backward()}},{key:"train",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=i.epochs,r=void 0===a?1:a,n=i.callback,s=i.log,o=void 0===s||s,h=i.miniBatchSize,l=void 0===h?1:h,u=i.shuffle,c=void 0!==u&&u;return this.miniBatchSize="boolean"==typeof l&&l?t[0].expected.length:l,new Promise(function(i,a){if(c&&NetUtil.shuffle(t),o&&console.log("Training started. Epochs: "+r+" Batch Size: "+e.miniBatchSize),void 0!==t&&null!==t){"initialised"!=e.state&&e.initLayers(t[0].input.length,(t[0].expected||t[0].output).length),e.layers.forEach(function(t){return t.state="training"});var s=0,h=0,l=Date.now(),u=function(){e.epochs++,e.error=0,s=0,void 0!=e.l2Error&&(e.l2Error=0),void 0!=e.l1Error&&(e.l1Error=0),f()},f=function c(){if(t[s].hasOwnProperty("input")&&(t[s].hasOwnProperty("expected")||t[s].hasOwnProperty("output"))){var f=t[s].input,v=e.forward(f),d=t[s].expected||t[s].output;e.backward(d),++s%e.miniBatchSize==0?(e.applyDeltaWeights(),e.resetDeltaWeights()):s>=t.length&&e.applyDeltaWeights();var g=e.cost(d,v),p=Date.now()-l;e.error+=g,e.iterations++,"function"==typeof n&&n({iterations:e.iterations,error:g,elapsed:p,input:f}),s<t.length?setTimeout(c.bind(e),0):(h++,o&&console.log("Epoch: "+e.epochs+" Error: "+e.error/s+(void 0==e.l2?"":" L2 Error: "+e.l2Error/s),"\nElapsed: "+NetUtil.format(p,"time")+" Average Duration: "+NetUtil.format(p/h,"time")),h<r?u():(e.layers.forEach(function(t){return t.state="initialised"}),o&&console.log("Training finished. Total time: "+NetUtil.format(p,"time")+"  Average iteration time: "+NetUtil.format(p/s,"time")),i()))}else a("Data set must be a list of objects with keys: 'input' and 'expected' (or 'output')")};e.resetDeltaWeights(),u()}else a("No data provided")})}},{key:"test",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=i.log,r=void 0===a||a,n=i.callback;return new Promise(function(i,a){void 0!==t&&null!==t||a("No data provided"),r&&console.log("Testing started");var s=0,o=0,h=Date.now();!function a(){var l=t[o].input,u=e.forward(l),c=t[o].expected||t[o].output,f=Date.now()-h,v=e.cost(c,u);s+=v,o++,"function"==typeof n&&n({iterations:o,error:v,elapsed:f,input:l}),o<t.length?setTimeout(a.bind(e),0):(r&&console.log("Testing finished. Total time: "+NetUtil.format(f,"time")+"  Average iteration time: "+NetUtil.format(f/o,"time")),i(s/t.length))}()})}},{key:"resetDeltaWeights",value:function(){this.layers.forEach(function(t,e){return e&&t.resetDeltaWeights()})}},{key:"applyDeltaWeights",value:function(){this.layers.forEach(function(t,e){return e&&t.applyDeltaWeights()}),void 0!=this.maxNorm&&(this.maxNormTotal=Math.sqrt(this.maxNormTotal),NetMath.maxNorm.bind(this)())}},{key:"toJSON",value:function(){return{layers:this.layers.map(function(t){return t.toJSON()})}}},{key:"fromJSON",value:function(t){if(void 0===t||null===t)throw new Error("No JSON data given to import.");if(t.layers.length!=this.layers.length)throw new Error("Mismatched layers ("+t.layers.length+" layers in import data, but "+this.layers.length+" configured)");this.resetDeltaWeights(),this.layers.forEach(function(e,i){return i&&e.fromJSON(t.layers[i],i)})}}],[{key:"version",get:function(){return"2.0.0"}}]),t}();"undefined"==typeof window&&(exports.Network=Network);var Neuron=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"init",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.updateFn,a=e.activation,r=e.eluAlpha,n=this.weights.length;switch(this.deltaWeights=this.weights.map(function(t){return 0}),i){case"gain":this.biasGain=1,this.weightGains=[].concat(_toConsumableArray(new Array(n))).map(function(t){return 1}),this.getWeightGain=function(e){return t.weightGains[e]},this.setWeightGain=function(e,i){return t.weightGains[e]=i};break;case"adagrad":case"rmsprop":case"adadelta":this.biasCache=0,this.weightsCache=[].concat(_toConsumableArray(new Array(n))).map(function(t){return 0}),this.getWeightsCache=function(e){return t.weightsCache[e]},this.setWeightsCache=function(e,i){return t.weightsCache[e]=i},"adadelta"==i&&(this.adadeltaBiasCache=0,this.adadeltaCache=[].concat(_toConsumableArray(new Array(n))).map(function(t){return 0}),this.getAdadeltaCache=function(e){return t.adadeltaCache[e]},this.setAdadeltaCache=function(e,i){return t.adadeltaCache[e]=i});break;case"adam":this.m=0,this.v=0}"rrelu"==a?this.rreluSlope=.001*Math.random():"elu"==a&&(this.eluAlpha=r)}},{key:"getWeight",value:function(t){return this.weights[t]}},{key:"setWeight",value:function(t,e){this.weights[t]=e}},{key:"getDeltaWeight",value:function(t){return this.deltaWeights[t]}},{key:"setDeltaWeight",value:function(t,e){this.deltaWeights[t]=e}}]),t}();"undefined"==typeof window&&(exports.Neuron=Neuron);var PoolLayer=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=i.stride,r=i.activation;_classCallCheck(this,t),e&&(this.size=e),a&&(this.stride=a),this.activation=void 0!=r&&0!=r&&("function"==typeof r?r:NetMath[NetUtil.format(r)].bind(this))}return _createClass(t,[{key:"init",value:function(){}},{key:"assignNext",value:function(t){this.nextLayer=t}},{key:"assignPrev",value:function(t,e){var i=this;this.prevLayer=t,this.size=this.size||this.net.pool.size||2,this.stride=this.stride||this.net.pool.stride||this.size;var a=t.outMapSize;switch(t.constructor.name){case"FCLayer":this.channels=this.net.channels,a=Math.max(Math.floor(Math.sqrt(t.size/this.channels)),1);break;case"ConvLayer":this.channels=t.size;break;case"PoolLayer":this.channels=t.channels}if(this.prevLayerOutWidth=a,this.outMapSize=(a-this.size)/this.stride+1,this.inMapValuesCount=Math.pow(a,2),this.outMapSize%1!=0)throw new Error("Misconfigured hyperparameters. Activation volume dimensions would be "+this.outMapSize+" in pool layer at index "+e);this.activations=[].concat(_toConsumableArray(new Array(this.channels))).map(function(t){return[].concat(_toConsumableArray(new Array(i.outMapSize))).map(function(t){return[].concat(_toConsumableArray(new Array(i.outMapSize))).map(function(t){return 0})})}),this.errors=[].concat(_toConsumableArray(new Array(this.channels))).map(function(t){return[].concat(_toConsumableArray(new Array(a))).map(function(t){return[].concat(_toConsumableArray(new Array(a))).map(function(t){return 0})})}),this.indeces=this.activations.map(function(t){return t.map(function(t){return t.map(function(t){return[0,0]})})})}},{key:"forward",value:function(){for(var t=0;t<this.channels;t++)if(NetMath.maxPool(this,t),this.activation)for(var e=0;e<this.outMapSize;e++)for(var i=0;i<this.outMapSize;i++)this.activations[t][e][i]=this.activation(this.activations[t][e][i],!1,this.net)}},{key:"backward",value:function(){for(var t=0;t<this.channels;t++)for(var e=0;e<this.errors[0].length;e++)for(var i=0;i<this.errors[0].length;i++)this.errors[t][e][i]=0;if(this.nextLayer instanceof FCLayer)for(var a=0;a<this.channels;a++)for(var r=0;r<this.outMapSize;r++)for(var n=0;n<this.outMapSize;n++)for(var s=this.indeces[a][r][n][0]+r*this.stride,o=this.indeces[a][r][n][1]+n*this.stride,h=(Math.pow(this.outMapSize,2),this.outMapSize,a*Math.pow(this.outMapSize,2)+r*this.outMapSize+n),l=0;l<this.nextLayer.neurons.length;l++)this.errors[a][s][o]+=this.nextLayer.neurons[l].error*this.nextLayer.neurons[l].weights[h];else if(this.nextLayer instanceof ConvLayer)for(var u=0;u<this.channels;u++){for(var c=[],f=0;f<this.outMapSize;f++)c[f]=0;NetUtil.buildConvErrorMap(this.nextLayer,c,u);for(var v=0;v<this.outMapSize;v++)for(var d=0;d<this.outMapSize;d++){var g=this.indeces[u][v][d][0]+v*this.stride,p=this.indeces[u][v][d][1]+d*this.stride;this.errors[u][g][p]+=c[v][d]}}else for(var y=0;y<this.channels;y++)for(var w=0;w<this.outMapSize;w++)for(var m=0;m<this.outMapSize;m++){var M=this.indeces[y][w][m][0]+w*this.stride,C=this.indeces[y][w][m][1]+m*this.stride;this.errors[y][M][C]+=this.nextLayer.errors[y][w][m]}if(this.activation)for(var b=0;b<this.channels;b++)for(var k=0;k<this.indeces[b].length;k++)for(var z=0;z<this.indeces[b].length;z++){var A=this.indeces[b][k][z][0]+k*this.stride,N=this.indeces[b][k][z][1]+z*this.stride;this.errors[b][A][N]*=this.activation(this.errors[b][A][N],!0,this.net)}}},{key:"resetDeltaWeights",value:function(){}},{key:"applyDeltaWeights",value:function(){}},{key:"toJSON",value:function(){return{}}},{key:"fromJSON",value:function(){}}]),t}();"undefined"==typeof window&&(exports.PoolLayer=PoolLayer);
//# sourceMappingURL=dist/jsNet.min.js.map