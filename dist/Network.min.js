"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),Layer=function(){function e(t,a){_classCallCheck(this,e),this.size=t,this.neurons=[].concat(_toConsumableArray(new Array(t))).map(function(e,t){return new Neuron(a?a[t]:void 0)})}return _createClass(e,[{key:"assignNext",value:function(e){this.nextLayer=e}},{key:"assignPrev",value:function(e){var t=this;this.prevLayer=e,this.neurons.forEach(function(a){return a.init(e.size,{adaptiveLR:t.adaptiveLR,activationConfig:t.activationConfig,eluAlpha:t.eluAlpha})})}},{key:"forward",value:function(e){var t=this;this.neurons.forEach(function(e,a){e.sum=e.bias,t.prevLayer.neurons.forEach(function(t,a){return e.sum+=t.activation*e.weights[a]}),e.activation=t.activation(e.sum,!1,e)})}},{key:"backward",value:function(e){var t=this;this.neurons.forEach(function(a,n){void 0!==e?a.error=e[n]-a.activation:(a.derivative=t.activation(a.sum,!0,a),a.error=a.derivative*t.nextLayer.neurons.map(function(e){return e.error*e.weights[n]}).reduce(function(e,t){return e+t},0)),a.weights.forEach(function(e,n){a.deltaWeights[n]+=a.error*t.prevLayer.neurons[n].activation}),a.deltaBias=a.error})}}]),e}();"undefined"==typeof window&&(global.Layer=Layer);var NetMath=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"sigmoid",value:function(e,t){var a=1/(1+Math.exp(-e));return t?a*(1-a):a}},{key:"tanh",value:function(e,t){var a=Math.exp(2*e);return t?4/Math.pow(Math.exp(e)+Math.exp(-e),2)||1e-18:(a-1)/(a+1)||1e-18}},{key:"relu",value:function(e,t){return t?e>0?1:0:Math.max(e,0)}},{key:"lrelu",value:function(e,t){return t?e>0?1:this.lreluSlope:Math.max(this.lreluSlope*Math.abs(e),e)}},{key:"rrelu",value:function(e,t,a){return t?e>0?1:a.rreluSlope:Math.max(a.rreluSlope,e)}},{key:"lecuntanh",value:function(t,a){return a?1.15333*Math.pow(e.sech(2/3*t),2):1.7159*e.tanh(2/3*t)}},{key:"elu",value:function(t,a,n){return a?t>=0?1:e.elu(t,!1,n)+n.eluAlpha:t>=0?t:n.eluAlpha*(Math.exp(t)-1)}},{key:"crossEntropy",value:function(e,t){return t.map(function(t,a){return e[a]*Math.log(t+1e-15)+(1-e[a])*Math.log(1+1e-15-t)}).reduce(function(e,t){return e-t},0)}},{key:"meanSquaredError",value:function(e,t){return e.map(function(e,a){return Math.pow(e-t[a],2)}).reduce(function(e,t){return e+t},0)/e.length}},{key:"noAdaptiveLR",value:function(e,t){return e+this.learningRate*t}},{key:"gain",value:function(e,t,a,n){var i=e+this.learningRate*t*(null==n?a.biasGain:a.weightGains[n]);return i<=0&&e>0||i>=0&&e<0?null!=n?a.weightGains[n]=Math.max(.95*a.weightGains[n],.5):a.biasGain=Math.max(.95*a.biasGain,.5):null!=n?a.weightGains[n]=Math.min(a.weightGains[n]+.05,5):a.biasGain=Math.min(a.biasGain+.05,5),i}},{key:"adagrad",value:function(e,t,a,n){return null!=n?a.weightsCache[n]+=Math.pow(t,2):a.biasCache+=Math.pow(t,2),e+this.learningRate*t/(1e-6+Math.sqrt(null!=n?a.weightsCache[n]:a.biasCache))}},{key:"RMSProp",value:function(e,t,a,n){return null!=n?a.weightsCache[n]=this.rmsDecay*a.weightsCache[n]+(1-this.rmsDecay)*Math.pow(t,2):a.biasCache=this.rmsDecay*a.biasCache+(1-this.rmsDecay)*Math.pow(t,2),e+this.learningRate*t/(1e-6+Math.sqrt(null!=n?a.weightsCache[n]:a.biasCache))}},{key:"adam",value:function(e,t,a){a.m=.9*a.m+(1-.9)*t;var n=a.m/(1-Math.pow(.9,this.iterations+1));a.v=.999*a.v+(1-.999)*Math.pow(t,2);var i=a.v/(1-Math.pow(.999,this.iterations+1));return e+this.learningRate*n/(Math.sqrt(i)+1e-8)}},{key:"adadelta",value:function(e,t,a,n){if(null!=n){a.weightsCache[n]=this.rho*a.weightsCache[n]+(1-this.rho)*Math.pow(t,2);var i=e+Math.sqrt((a.adadeltaCache[n]+1e-6)/(a.weightsCache[n]+1e-6))*t;return a.adadeltaCache[n]=this.rho*a.adadeltaCache[n]+(1-this.rho)*Math.pow(t,2),i}a.biasCache=this.rho*a.biasCache+(1-this.rho)*Math.pow(t,2);var r=e+Math.sqrt((a.adadeltaBiasCache+1e-6)/(a.biasCache+1e-6))*t;return a.adadeltaBiasCache=this.rho*a.adadeltaBiasCache+(1-this.rho)*Math.pow(t,2),r}},{key:"softmax",value:function(e){var t=e.reduce(function(e,t){return e+t},0);return e.map(function(e){return e/t})}},{key:"sech",value:function(e){return 2*Math.exp(-e)/(1+Math.exp(-2*e))}}]),e}();"undefined"==typeof window&&(global.NetMath=NetMath);var Network=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=t.learningRate,n=t.layers,i=void 0===n?[]:n,r=t.adaptiveLR,s=void 0===r?"noAdaptiveLR":r,o=t.activation,h=void 0===o?"sigmoid":o,u=t.cost,l=void 0===u?"crossEntropy":u,c=t.rmsDecay,d=t.rho,f=t.lreluSlope,v=t.eluAlpha;switch(_classCallCheck(this,e),this.state="not-defined",this.layers=[],this.epochs=0,this.iterations=0,null!=a&&(this.learningRate=a),!0){case"RMSProp"==s:this.learningRate=void 0==this.learningRate?.001:this.learningRate;break;case"adam"==s:this.learningRate=void 0==this.learningRate?.01:this.learningRate;break;case"adadelta"==s:this.rho=null==d?.95:d;break;default:if(void 0==this.learningRate)switch(h){case"relu":case"lrelu":case"rrelu":case"elu":this.learningRate=.01;break;case"tanh":case"lecuntanh":this.learningRate=.001;break;default:this.learningRate=.2}}if(this.adaptiveLR=[!1,null,void 0].includes(s)?"noAdaptiveLR":s,this.weightUpdateFn=NetMath[this.adaptiveLR],this.activation=NetMath[h].bind(this),this.activationConfig=h,this.cost=NetMath[l],"RMSProp"==this.adaptiveLR&&(this.rmsDecay=void 0==c?.99:c),"lrelu"==h?this.lreluSlope=void 0==f?-5e-4:f:"elu"==h&&(this.eluAlpha=void 0==v?1:v),i.length)switch(!0){case i.every(function(e){return Number.isInteger(e)}):this.layers=i.map(function(e){return new Layer(e)}),this.state="constructed",this.initLayers();break;case i.every(function(e){return e instanceof Layer}):this.state="constructed",this.layers=i,this.initLayers();break;case i.every(function(e){return e===Layer}):this.state="defined",this.definedLayers=i;break;default:throw new Error("There was an error constructing from the layers given.")}}return _createClass(e,[{key:"initLayers",value:function(e,t){var a=this;switch(this.state){case"initialised":return;case"defined":this.layers=this.definedLayers.map(function(n,i){if(!i)return new n(e);if(i==a.definedLayers.length-1)return new n(t);var r=a.definedLayers.length-2,s=e/t>5?t+(t+Math.abs(e-t)/4)*(r-i+1)/(r/2):e>=t?e+t*(r-i)/(r/2):t+e*(r-i)/(r/2);return new n(Math.max(Math.round(s),0))});break;case"not-defined":this.layers[0]=new Layer(e),this.layers[1]=new Layer(Math.ceil(e/t>5?t+Math.abs(e-t)/4:e+t)),this.layers[2]=new Layer(Math.ceil(t))}this.layers.forEach(this.joinLayer.bind(this)),this.state="initialised"}},{key:"joinLayer",value:function(e,t){e.activation=this.activation,e.adaptiveLR=this.adaptiveLR,e.activationConfig=this.activationConfig,void 0!=this.rho&&(e.rho=this.rho),void 0!=this.eluAlpha&&(e.eluAlpha=this.eluAlpha),t&&(this.layers[t-1].assignNext(e),e.assignPrev(this.layers[t-1]))}},{key:"forward",value:function(e){if("initialised"!=this.state)throw new Error("The network layers have not been initialised.");if(void 0===e)throw new Error("No data passed to Network.forward()");return e.length!=this.layers[0].neurons.length&&console.warn("Input data length did not match input layer neurons count."),this.layers[0].neurons.forEach(function(t,a){return t.activation=e[a]}),this.layers.forEach(function(t,a){return a&&t.forward(e)}),this.layers[this.layers.length-1].neurons.map(function(e){return e.activation})}},{key:"backward",value:function(e){if(void 0===e)throw new Error("No data passed to Network.backward()");e.length!=this.layers[this.layers.length-1].neurons.length&&console.warn("Expected data length did not match output layer neurons count."),this.layers[this.layers.length-1].backward(e);for(var t=this.layers.length-2;t>0;t--)this.layers[t].backward()}},{key:"train",value:function(e){var t=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a.epochs,i=void 0===n?1:n,r=a.callback;return new Promise(function(a,n){void 0!==e&&null!==e||n("No data provided"),"initialised"!=t.state&&t.initLayers(e[0].input.length,(e[0].expected||e[0].output).length);var s=0,o=0,h=0,u=function(){t.epochs++,s=0,l()},l=function l(){if(!e[s].hasOwnProperty("input")||!e[s].hasOwnProperty("expected")&&!e[s].hasOwnProperty("output"))return n("Data set must be a list of objects with keys: 'input' and 'expected' (or 'output')");t.resetDeltaWeights();var c=e[s].input,d=t.forward(c),f=e[s].expected||e[s].output;t.backward(f),t.applyDeltaWeights();var v=t.cost(f,d);h+=v,"function"==typeof r&&r({iterations:t.iterations,error:v,input:c}),t.iterations++,++s<e.length?setTimeout(l.bind(t),0):(o++,console.log("Epoch: "+o+" Error: "+h/100),o<i?u():a())};u()})}},{key:"test",value:function(e){var t=this;return new Promise(function(a,n){void 0!==e&&null!==e||n("No data provided");var i=0,r=0;!function n(){console.log("Testing iteration",r+1,i/(r+1));var s=t.forward(e[r].input),o=e[r].expected||e[r].output;i+=t.cost(o,s),++r<e.length?setTimeout(n.bind(t),0):a(i/e.length)}()})}},{key:"resetDeltaWeights",value:function(){this.layers.forEach(function(e,t){t&&e.neurons.forEach(function(e){e.deltaWeights=e.weights.map(function(e){return 0})})})}},{key:"applyDeltaWeights",value:function(){var e=this;this.layers.forEach(function(t,a){a&&t.neurons.forEach(function(t){t.deltaWeights.forEach(function(a,n){t.weights[n]=e.weightUpdateFn.bind(e,t.weights[n],a,t,n)()}),t.bias=e.weightUpdateFn.bind(e,t.bias,t.deltaBias,t)()})})}},{key:"toJSON",value:function(){return{layers:this.layers.map(function(e){return{neurons:e.neurons.map(function(e){return{bias:e.bias,weights:e.weights}})}})}}},{key:"fromJSON",value:function(e){if(void 0===e||null===e)throw new Error("No JSON data given to import.");this.layers=e.layers.map(function(e){return new Layer(e.neurons.length,e.neurons)}),this.state="constructed",this.initLayers()}}]),e}();"undefined"==typeof window&&(global.Network=Network);var Neuron=function(){function e(t){_classCallCheck(this,e),t&&(this.imported=!0,this.weights=t.weights||[],this.bias=t.bias)}return _createClass(e,[{key:"init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.adaptiveLR,n=t.activationConfig,i=t.eluAlpha;switch(this.imported||(this.weights=[].concat(_toConsumableArray(new Array(e))).map(function(e){return.2*Math.random()-.1}),this.bias=.2*Math.random()-.1),this.deltaWeights=this.weights.map(function(e){return 0}),a){case"gain":this.weightGains=[].concat(_toConsumableArray(new Array(e))).map(function(e){return 1}),this.biasGain=1;break;case"adagrad":case"RMSProp":case"adadelta":this.biasCache=0,this.weightsCache=[].concat(_toConsumableArray(new Array(e))).map(function(e){return 0}),"adadelta"==a&&(this.adadeltaCache=[].concat(_toConsumableArray(new Array(e))).map(function(e){return 0}),this.adadeltaBiasCache=0);break;case"adam":this.m=0,this.v=0}"rrelu"==n?this.rreluSlope=.001*Math.random():"elu"==n&&(this.eluAlpha=i)}}]),e}();"undefined"==typeof window&&(global.Neuron=Neuron);
//# sourceMappingURL=dist/Network.min.js.map