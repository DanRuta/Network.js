"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),FCLayer=function(){function t(e,a){_classCallCheck(this,t),this.size=e,this.neurons=[].concat(_toConsumableArray(new Array(e))).map(function(t,e){return new Neuron(a?a[e]:void 0)}),this.state="not-initialised"}return _createClass(t,[{key:"assignNext",value:function(t){this.nextLayer=t}},{key:"assignPrev",value:function(t){var e=this;this.prevLayer=t,this.neurons.forEach(function(a){a.imported||(a.weights=e.net.weightsInitFn(t.size,e.weightsConfig),a.bias=.2*Math.random()-.1),a.init(t.size,{adaptiveLR:e.net.adaptiveLR,activationConfig:e.net.activationConfig,eluAlpha:e.net.eluAlpha})}),this.state="initialised"}},{key:"forward",value:function(t){var e=this;this.neurons.forEach(function(t,a){"training"==e.state&&(t.dropped=Math.random()>e.net.dropout)?t.activation=0:(t.sum=t.bias,e.prevLayer.neurons.forEach(function(e,a){return t.sum+=e.activation*t.weights[a]}),t.activation=e.activation(t.sum,!1,t)/(1|e.net.dropout))})}},{key:"backward",value:function(t){var e=this;this.neurons.forEach(function(a,n){a.dropped?(a.error=0,a.deltaBias=0):(void 0!==t?a.error=t[n]-a.activation:(a.derivative=e.activation(a.sum,!0,a),a.error=a.derivative*e.nextLayer.neurons.map(function(t){return t.error*(0|t.weights[n])}).reduce(function(t,e){return t+e},0)),a.weights.forEach(function(t,n){a.deltaWeights[n]+=a.error*e.prevLayer.neurons[n].activation*(1+((e.net.l2||0)+(e.net.l1||0))/e.net.miniBatchSize*a.deltaWeights[n])}),a.deltaBias=a.error)})}},{key:"resetDeltaWeights",value:function(){this.neurons.forEach(function(t){return t.deltaWeights=t.weights.map(function(t){return 0})})}},{key:"applyDeltaWeights",value:function(){var t=this;this.neurons.forEach(function(e){e.deltaWeights.forEach(function(a,n){void 0!=t.net.l2&&(t.net.l2Error+=.5*t.net.l2*Math.pow(e.weights[n],2)),void 0!=t.net.l1&&(t.net.l1Error+=t.net.l1*Math.abs(e.weights[n])),e.weights[n]=t.net.weightUpdateFn.bind(t.net,e.weights[n],a,e,n)(),void 0!=t.net.maxNorm&&(t.net.maxNormTotal+=Math.pow(e.weights[n],2))}),e.bias=t.net.weightUpdateFn.bind(t.net,e.bias,e.deltaBias,e)()})}}]),t}(),Layer=FCLayer;"undefined"==typeof window&&(exports.FCLayer=exports.Layer=FCLayer);var NetMath=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"sigmoid",value:function(t,e){var a=1/(1+Math.exp(-t));return e?a*(1-a):a}},{key:"tanh",value:function(t,e){var a=Math.exp(2*t);return e?4/Math.pow(Math.exp(t)+Math.exp(-t),2)||1e-18:(a-1)/(a+1)||1e-18}},{key:"relu",value:function(t,e){return e?t>0?1:0:Math.max(t,0)}},{key:"lrelu",value:function(t,e){return e?t>0?1:this.lreluSlope:Math.max(this.lreluSlope*Math.abs(t),t)}},{key:"rrelu",value:function(t,e,a){return e?t>0?1:a.rreluSlope:Math.max(a.rreluSlope,t)}},{key:"lecuntanh",value:function(e,a){return a?1.15333*Math.pow(t.sech(2/3*e),2):1.7159*t.tanh(2/3*e)}},{key:"elu",value:function(e,a,n){return a?e>=0?1:t.elu(e,!1,n)+n.eluAlpha:e>=0?e:n.eluAlpha*(Math.exp(e)-1)}},{key:"crossentropy",value:function(t,e){return e.map(function(e,a){return t[a]*Math.log(e+1e-15)+(1-t[a])*Math.log(1+1e-15-e)}).reduce(function(t,e){return t-e},0)}},{key:"meansquarederror",value:function(t,e){return t.map(function(t,a){return Math.pow(t-e[a],2)}).reduce(function(t,e){return t+e},0)/t.length}},{key:"noadaptivelr",value:function(t,e){return t+this.learningRate*e}},{key:"gain",value:function(t,e,a,n){var i=t+this.learningRate*e*(null==n?a.biasGain:a.getWeightGain(n));return i<=0&&t>0||i>=0&&t<0?null!=n?a.setWeightGain(n,Math.max(.95*a.getWeightGain(n),.5)):a.biasGain=Math.max(.95*a.biasGain,.5):null!=n?a.setWeightGain(n,Math.min(a.getWeightGain(n)+.05,5)):a.biasGain=Math.min(a.biasGain+.05,5),i}},{key:"adagrad",value:function(t,e,a,n){return null!=n?a.setWeightsCache(n,n+Math.pow(e,2)):a.biasCache+=Math.pow(e,2),t+this.learningRate*e/(1e-6+Math.sqrt(null!=n?a.getWeightsCache(n):a.biasCache))}},{key:"rmsprop",value:function(t,e,a,n){return null!=n?a.setWeightsCache(n,this.rmsDecay*a.getWeightsCache(n)+(1-this.rmsDecay)*Math.pow(e,2)):a.biasCache=this.rmsDecay*a.biasCache+(1-this.rmsDecay)*Math.pow(e,2),t+this.learningRate*e/(1e-6+Math.sqrt(null!=n?a.getWeightsCache(n):a.biasCache))}},{key:"adam",value:function(t,e,a){a.m=.9*a.m+(1-.9)*e;var n=a.m/(1-Math.pow(.9,this.iterations+1));a.v=.999*a.v+(1-.999)*Math.pow(e,2);var i=a.v/(1-Math.pow(.999,this.iterations+1));return t+this.learningRate*n/(Math.sqrt(i)+1e-8)}},{key:"adadelta",value:function(t,e,a,n){if(null!=n){a.setWeightsCache(n,this.rho*a.getWeightsCache(n)+(1-this.rho)*Math.pow(e,2));var i=t+Math.sqrt((a.getAdadeltaCache(n)+1e-6)/(a.getWeightsCache(n)+1e-6))*e;return a.setAdadeltaCache(n,this.rho*a.getAdadeltaCache(n)+(1-this.rho)*Math.pow(e,2)),i}a.biasCache=this.rho*a.biasCache+(1-this.rho)*Math.pow(e,2);var r=t+Math.sqrt((a.adadeltaBiasCache+1e-6)/(a.biasCache+1e-6))*e;return a.adadeltaBiasCache=this.rho*a.adadeltaBiasCache+(1-this.rho)*Math.pow(e,2),r}},{key:"uniform",value:function(t,e){var a=e.limit;return[].concat(_toConsumableArray(new Array(t))).map(function(t){return 2*Math.random()*a-a})}},{key:"gaussian",value:function(t,e){var a=e.mean,n=e.stdDeviation;return[].concat(_toConsumableArray(new Array(t))).map(function(){var t=void 0,e=void 0,i=void 0;do{t=2*Math.random()-1,e=2*Math.random()-1,i=Math.pow(t,2)+Math.pow(e,2)}while(i>=1||!i);return a+t*Math.sqrt(-2*Math.log(i)/i)*n})}},{key:"xaviernormal",value:function(e,a){var n=a.fanIn,i=a.fanOut;return i||0==i?t.gaussian(e,{mean:0,stdDeviation:Math.sqrt(2/(n+i))}):t.lecunnormal(e,{fanIn:n})}},{key:"xavieruniform",value:function(e,a){var n=a.fanIn,i=a.fanOut;return i||0==i?t.uniform(e,{limit:Math.sqrt(6/(n+i))}):t.lecununiform(e,{fanIn:n})}},{key:"lecunnormal",value:function(e,a){var n=a.fanIn;return t.gaussian(e,{mean:0,stdDeviation:Math.sqrt(1/n)})}},{key:"lecununiform",value:function(e,a){var n=a.fanIn;return t.uniform(e,{limit:Math.sqrt(3/n)})}},{key:"softmax",value:function(t){var e=t.reduce(function(t,e){return t+e},0);return t.map(function(t){return t/e})}},{key:"sech",value:function(t){return 2*Math.exp(-t)/(1+Math.exp(-2*t))}},{key:"standardDeviation",value:function(t){var e=t.reduce(function(t,e){return t+e})/t.length,a=t.map(function(t){return t-e}).map(function(t){return Math.pow(t,2)});return Math.sqrt(a.reduce(function(t,e){return t+e})/a.length)}},{key:"maxNorm",value:function(){if(this.maxNormTotal>this.maxNorm){var t=this.maxNorm/(1e-18+this.maxNormTotal);this.layers.forEach(function(e,a){a&&e.neurons.forEach(function(e){e.weights.forEach(function(a,n){return e.setWeight(n,e.getWeight(n)*t)})})})}this.maxNormTotal=0}}]),t}();"undefined"==typeof window&&(exports.NetMath=NetMath);var NetUtil=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"format",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"string";switch(!0){case"string"==e&&"string"==typeof t:t=t.replace(/(_|\s)/g,"").toLowerCase();break;case"time"==e&&"number"==typeof t:var a=new Date(t),n=[];t<1e3?n.push(a.getMilliseconds()+"ms"):(t>=36e5&&n.push(a.getHours()+"h"),t>=6e4&&n.push(a.getMinutes()+"m"),n.push(a.getSeconds()+"s")),t=n.join(" ")}return t}},{key:"shuffle",value:function(t){for(var e=t.length;e;e--){var a=Math.floor(Math.random()*e),n=t[e-1];t[e-1]=t[a],t[a]=n}}},{key:"addZeroPadding",value:function(t,e){var a=[].concat(_toConsumableArray(new Array(e))).map(function(t){return 0});t=t.map(function(t){return[].concat(_toConsumableArray(a),_toConsumableArray(t),_toConsumableArray(a))});var n=[].concat(_toConsumableArray(new Array(e))).map(function(a){return[].concat(_toConsumableArray(new Array(t.length+2*e))).map(function(t){return 0})});return[].concat(_toConsumableArray(n.slice(0)),_toConsumableArray(t),_toConsumableArray(n.slice(0)))}},{key:"build2DPSA",value:function(t){for(var e=t.length,a=[].concat(_toConsumableArray(new Array(e+1))).map(function(t){return[].concat(_toConsumableArray(new Array(e+1))).map(function(t){return 0})}),n=1;n<=e;n++)for(var i=1;i<=e;i++)a[n][i]=a[n-1][i]+t[n-1][i-1];for(var r=1;r<=e;r++)for(var o=1;o<=e;o++)a[r][o]+=a[r][o-1];return a}},{key:"sum2DPSA",value:function(t,e,a){for(var n=t.length,i=[].concat(_toConsumableArray(new Array(n-1-2*e))).map(function(t){return[].concat(_toConsumableArray(new Array(n-1-2*e))).map(function(t){return 0})}),r=n-e;r>e+1;r--)for(var o=n-e;o>e+1;o--){var s=o-a,h=r-a;i[r-Math.floor(a)][o-Math.floor(a)]=t[r][o]-t[r][s]-t[h][o]+t[h][s]}return i}}]),t}();"undefined"==typeof window&&(exports.NetUtil=NetUtil);var Network=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.learningRate,n=e.layers,i=void 0===n?[]:n,r=e.adaptiveLR,o=void 0===r?"noadaptivelr":r,s=e.activation,h=void 0===s?"sigmoid":s,u=e.cost,l=void 0===u?"meansquarederror":u,c=e.rmsDecay,f=e.rho,d=e.lreluSlope,g=e.eluAlpha,v=e.dropout,y=void 0===v?1:v,m=e.l2,p=void 0===m||m,w=e.l1,C=void 0===w||w,b=e.maxNorm,k=e.weightsConfig;switch(_classCallCheck(this,t),this.state="not-defined",this.layers=[],this.epochs=0,this.iterations=0,this.dropout=0==y?1:y,this.error=0,h=NetUtil.format(h),o=NetUtil.format(o),l=NetUtil.format(l),null!=a&&(this.learningRate=a),p&&(this.l2="boolean"==typeof p?.001:p,this.l2Error=0),C&&(this.l1="boolean"==typeof C?.005:C,this.l1Error=0),b&&(this.maxNorm="boolean"==typeof b&&b?1e3:b,this.maxNormTotal=0),o){case"rmsprop":this.learningRate=void 0==this.learningRate?.001:this.learningRate;break;case"adam":this.learningRate=void 0==this.learningRate?.01:this.learningRate;break;case"adadelta":this.rho=null==f?.95:f;break;default:if(void 0==this.learningRate)switch(h){case"relu":case"lrelu":case"rrelu":case"elu":this.learningRate=.01;break;case"tanh":case"lecuntanh":this.learningRate=.001;break;default:this.learningRate=.2}}if(this.adaptiveLR=[!1,null,void 0].includes(o)?"noadaptivelr":o,this.weightUpdateFn=NetMath[this.adaptiveLR],this.activation="function"==typeof h?h:NetMath[h].bind(this),this.activationConfig=h,this.cost="function"==typeof l?l:NetMath[l],"rmsprop"==this.adaptiveLR&&(this.rmsDecay=void 0==c?.99:c),"lrelu"==h?this.lreluSlope=void 0==d?-5e-4:d:"elu"==h&&(this.eluAlpha=void 0==g?1:g),this.weightsConfig={distribution:"xavieruniform"},void 0!=k&&k.distribution&&(this.weightsConfig.distribution=NetUtil.format(k.distribution)),"uniform"==this.weightsConfig.distribution?this.weightsConfig.limit=k&&void 0!=k.limit?k.limit:.1:"gaussian"==this.weightsConfig.distribution&&(this.weightsConfig.mean=k.mean||0,this.weightsConfig.stdDeviation=k.stdDeviation||.05),"function"==typeof this.weightsConfig.distribution?this.weightsInitFn=this.weightsConfig.distribution:this.weightsInitFn=NetMath[this.weightsConfig.distribution],i.length)switch(!0){case i.every(function(t){return Number.isInteger(t)}):this.layers=i.map(function(t){return new Layer(t)}),this.state="constructed",this.initLayers();break;case i.every(function(t){return t instanceof Layer||t instanceof FCLayer}):this.state="constructed",this.layers=i,this.initLayers();break;case i.every(function(t){return t===Layer||t===FCLayer}):this.state="defined",this.definedLayers=i;break;default:throw new Error("There was an error constructing from the layers given.")}}return _createClass(t,[{key:"initLayers",value:function(t,e){var a=this;switch(this.state){case"initialised":return;case"defined":this.layers=this.definedLayers.map(function(n,i){if(!i)return new n(t);if(i==a.definedLayers.length-1)return new n(e);var r=a.definedLayers.length-2,o=t/e>5?e+(e+Math.abs(t-e)/4)*(r-i+1)/(r/2):t>=e?t+e*(r-i)/(r/2):e+t*(r-i)/(r/2);return new n(Math.max(Math.round(o),0))});break;case"not-defined":this.layers[0]=new FCLayer(t),this.layers[1]=new FCLayer(Math.ceil(t/e>5?e+Math.abs(t-e)/4:t+e)),this.layers[2]=new FCLayer(Math.ceil(e))}this.layers.forEach(this.joinLayer.bind(this)),this.state="initialised"}},{key:"joinLayer",value:function(t,e){t.net=this,t.activation=this.activation,t.weightsConfig={},Object.assign(t.weightsConfig,this.weightsConfig),e&&(t.weightsConfig.fanIn=this.layers[e-1].size,this.layers[e-1].weightsConfig.fanOut=t.size,this.layers[e-1].assignNext(t),t.assignPrev(this.layers[e-1]))}},{key:"forward",value:function(t){if("initialised"!=this.state)throw new Error("The network layers have not been initialised.");if(void 0===t)throw new Error("No data passed to Network.forward()");return t.length!=this.layers[0].neurons.length&&console.warn("Input data length did not match input layer neurons count."),this.layers[0].neurons.forEach(function(e,a){return e.activation=t[a]}),this.layers.forEach(function(e,a){return a&&e.forward(t)}),this.layers[this.layers.length-1].neurons.map(function(t){return t.activation})}},{key:"backward",value:function(t){if(void 0===t)throw new Error("No data passed to Network.backward()");t.length!=this.layers[this.layers.length-1].neurons.length&&console.warn("Expected data length did not match output layer neurons count.",t),this.layers[this.layers.length-1].backward(t);for(var e=this.layers.length-2;e>0;e--)this.layers[e].backward()}},{key:"train",value:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a.epochs,i=void 0===n?1:n,r=a.callback,o=a.log,s=void 0===o||o,h=a.miniBatchSize,u=void 0===h?1:h,l=a.shuffle,c=void 0!==l&&l;return this.miniBatchSize="boolean"==typeof u&&u?t[0].expected.length:u,c&&NetUtil.shuffle(t),s&&console.log("Training started. Epochs: "+i+" Batch Size: "+this.miniBatchSize),new Promise(function(a,n){if(void 0!==t&&null!==t){"initialised"!=e.state&&e.initLayers(t[0].input.length,(t[0].expected||t[0].output).length),e.layers.forEach(function(t){return t.state="training"});var o=0,h=0,u=Date.now(),l=function(){e.epochs++,e.error=0,o=0,void 0!=e.l2Error&&(e.l2Error=0),void 0!=e.l1Error&&(e.l1Error=0),c()},c=function c(){if(t[o].hasOwnProperty("input")&&(t[o].hasOwnProperty("expected")||t[o].hasOwnProperty("output"))){var f=t[o].input,d=e.forward(f),g=t[o].expected||t[o].output;e.backward(g),++o%e.miniBatchSize==0?(e.applyDeltaWeights(),e.resetDeltaWeights()):o>=t.length&&e.applyDeltaWeights();var v=e.cost(g,d),y=Date.now()-u;e.error+=v,e.iterations++,"function"==typeof r&&r({iterations:e.iterations,error:v,elapsed:y,input:f}),o<t.length?setTimeout(c.bind(e),0):(h++,s&&console.log("Epoch: "+e.epochs+" Error: "+e.error/o+(void 0==e.l2?"":" L2 Error: "+e.l2Error/o),"\nElapsed: "+NetUtil.format(y,"time")+" Average Duration: "+NetUtil.format(y/h,"time")),h<i?l():(e.layers.forEach(function(t){return t.state="initialised"}),s&&console.log("Training finished. Total time: "+NetUtil.format(y,"time")+"  Average iteration time: "+NetUtil.format(y/o,"time")),a()))}else n("Data set must be a list of objects with keys: 'input' and 'expected' (or 'output')")};e.resetDeltaWeights(),l()}else n("No data provided")})}},{key:"test",value:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a.log,i=void 0===n||n,r=a.callback;return new Promise(function(a,n){void 0!==t&&null!==t||n("No data provided");var o=0,s=0,h=Date.now();!function n(){var u=t[s].input,l=e.forward(u),c=t[s].expected||t[s].output,f=Date.now()-h,d=e.cost(c,l);o+=d,s++,i&&console.log("Testing iteration",s,d),"function"==typeof r&&r({iterations:s,error:d,elapsed:f,input:u}),s<t.length?setTimeout(n.bind(e),0):(i&&console.log("Testing finished. Total time: "+NetUtil.format(f,"time")+"  Average iteration time: "+NetUtil.format(f/s,"time")),a(o/t.length))}()})}},{key:"resetDeltaWeights",value:function(){this.layers.forEach(function(t,e){return e&&t.resetDeltaWeights()})}},{key:"applyDeltaWeights",value:function(){this.layers.forEach(function(t,e){return e&&t.applyDeltaWeights()}),void 0!=this.maxNorm&&(this.maxNormTotal=Math.sqrt(this.maxNormTotal),NetMath.maxNorm.bind(this)())}},{key:"toJSON",value:function(){return{layers:this.layers.map(function(t){return{neurons:t.neurons.map(function(t){return{bias:t.bias,weights:t.weights}})}})}}},{key:"fromJSON",value:function(t){if(void 0===t||null===t)throw new Error("No JSON data given to import.");this.layers=t.layers.map(function(t){return new FCLayer(t.neurons.length,t.neurons)}),this.state="constructed",this.initLayers()}}]),t}();"undefined"==typeof window&&(exports.Network=Network);var Neuron=function(){function t(e){_classCallCheck(this,t),e&&(this.imported=!0,this.weights=e.weights||[],this.bias=e.bias)}return _createClass(t,[{key:"init",value:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a.adaptiveLR,i=a.activationConfig,r=a.eluAlpha;switch(this.deltaWeights=this.weights.map(function(t){return 0}),n){case"gain":this.biasGain=1,this.weightGains=[].concat(_toConsumableArray(new Array(t))).map(function(t){return 1}),this.getWeightGain=function(t){return e.weightGains[t]},this.setWeightGain=function(t,a){return e.weightGains[t]=a};break;case"adagrad":case"rmsprop":case"adadelta":this.biasCache=0,this.weightsCache=[].concat(_toConsumableArray(new Array(t))).map(function(t){return 0}),this.getWeightsCache=function(t){return e.weightsCache[t]},this.setWeightsCache=function(t,a){return e.weightsCache[t]=a},"adadelta"==n&&(this.adadeltaBiasCache=0,this.adadeltaCache=[].concat(_toConsumableArray(new Array(t))).map(function(t){return 0}),this.getAdadeltaCache=function(t){return e.adadeltaCache[t]},this.setAdadeltaCache=function(t,a){return e.adadeltaCache[t]=a});break;case"adam":this.m=0,this.v=0}"rrelu"==i?this.rreluSlope=.001*Math.random():"elu"==i&&(this.eluAlpha=r)}},{key:"getWeight",value:function(t){return this.weights[t]}},{key:"setWeight",value:function(t,e){this.weights[t]=e}},{key:"getDeltaWeight",value:function(t){return this.deltaWeights[t]}},{key:"setDeltaWeight",value:function(t,e){this.deltaWeights[t]=e}}]),t}();"undefined"==typeof window&&(exports.Neuron=Neuron);
//# sourceMappingURL=dist/Network.min.js.map